{% extends 'main/base.html' %} {% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Messages</h2>

  <div class="row">
    <!-- LEFT SIDEBAR: List of users to chat with -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Conversations</h5>
        </div>
        <div class="list-group list-group-flush">
          <!-- Loop through all users -->
          {% for user in users %}
          <a
            href="?user_id={{ user.id }}"
            class="list-group-item list-group-item-action {% if conversation_with and conversation_with.id == user.id %}active{% endif %}"
          >
            <strong>{{ user.username }}</strong>
            <br />
            <small class="text-muted">{{ user.email }}</small>
          </a>
          {% empty %}
          <div class="list-group-item text-muted">
            No users available to chat with
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- RIGHT SIDE: Chat conversation -->
    <div class="col-md-8">
      {% if conversation_with %}
      <!-- We have selected someone to chat with -->
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ðŸ’¬ Chat with {{ conversation_with.username }}</h5>
        </div>

        <!-- Message Display Area -->
        <div
          id="chat-messages"
          class="card-body"
          style="height: 400px; overflow-y: auto; background-color: #f8f9fa"
        >
          {% for message in conversation_messages %}
          <div
            class="mb-3 {% if message.sender == request.user %}text-end{% endif %}"
          >
            <!-- Message bubble -->
            <div
              class="d-inline-block p-3 rounded shadow-sm {% if message.sender == request.user %} bg-primary text-white {% else %} bg-white {% endif %}"
              style="max-width: 70%"
            >
              <!-- Show sender name -->
              <small class="d-block">
                <strong>{{ message.sender.username }}</strong>
              </small>
              <!-- Message content -->
              <div>{{ message.content }}</div>
              <!-- Timestamp -->
              <small class="d-block mt-1" style="opacity: 0.8">
                {{ message.timestamp|date:"M d, h:i A" }}
              </small>
            </div>
          </div>
          {% empty %}
          <div class="text-center text-muted mt-5">
            <p>No messages yet. Start the conversation!</p>
          </div>
          {% endfor %}
        </div>

        <!-- Message Input Form -->
        <div class="card-footer">
          <form id="chat-form" class="d-flex gap-2">
            {% csrf_token %}
            <!-- Hidden field to track who we're sending to -->
            <input
              type="hidden"
              id="receiver-id"
              value="{{ conversation_with.id }}"
            />

            <!-- Text input -->
            <input
              type="text"
              id="message-input"
              class="form-control"
              placeholder="Type your message..."
              required
              autofocus
            />

            <!-- Send button -->
            <button type="submit" class="btn btn-primary">Send</button>
          </form>
        </div>
      </div>
      {% else %}
      <!-- No user selected yet -->
      <div class="card">
        <div class="card-body text-center py-5">
          <div class="text-muted">
            <h4>ðŸ‘ˆ Select a user to start chatting</h4>
            <p>Choose someone from the list on the left</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% if conversation_with %}
<script>
  /*
   * REAL-TIME CHAT WITH WEBSOCKETS
   *
   * How it works:
   * 1. Create a WebSocket connection to the server
   * 2. Listen for incoming messages from the server
   * 3. When user sends a message, send it via WebSocket (not HTTP form)
   * 4. Display incoming messages in real-time without page refresh
   */

  // Get the current user ID and conversation partner ID
  const currentUserId = {{ request.user.id }};
  const otherUserId = {{ conversation_with.id }};

  // Determine WebSocket protocol (ws:// for http, wss:// for https)
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

  // Create WebSocket connection
  // This connects to our ChatConsumer at ws://localhost:8000/ws/chat/5/
  const chatSocket = new WebSocket(
      protocol + '//' + window.location.host + '/ws/chat/' + otherUserId + '/'
  );

  // Event: WebSocket connection opened
  chatSocket.onopen = function(e) {
      console.log('WebSocket connected!');
  };

  // Event: Received a message from the server
  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log('Received message:', data);

      // Add the new message to the chat display
      appendMessage(
          data.sender_username,
          data.message,
          data.timestamp,
          data.sender_id === currentUserId
      );

      // Scroll to the bottom to show the new message
      scrollToBottom();
  };

  // Event: WebSocket connection closed
  chatSocket.onclose = function(e) {
      console.log('WebSocket disconnected');
  };

  // Event: WebSocket error
  chatSocket.onerror = function(e) {
      console.error('WebSocket error:', e);
  };

  // Handle form submission
  document.getElementById('chat-form').onsubmit = function(e) {
      e.preventDefault();  // Prevent normal form submission

      const messageInput = document.getElementById('message-input');
      const message = messageInput.value.trim();

      if (message) {
          // Send message via WebSocket (not HTTP POST)
          chatSocket.send(JSON.stringify({
              'message': message,
              'receiver_id': otherUserId
          }));

          // Clear the input field
          messageInput.value = '';
      }
  };

  // Function to add a new message to the display
  function appendMessage(senderUsername, content, timestamp, isCurrentUser) {
      const messagesContainer = document.getElementById('chat-messages');

      // Create message HTML
      const messageDiv = document.createElement('div');
      messageDiv.className = 'mb-3 ' + (isCurrentUser ? 'text-end' : '');

      messageDiv.innerHTML = `
          <div class="d-inline-block p-3 rounded shadow-sm ${isCurrentUser ? 'bg-primary text-white' : 'bg-white'}"
               style="max-width: 70%;">
              <small class="d-block">
                  <strong>${senderUsername}</strong>
              </small>
              <div>${content}</div>
              <small class="d-block mt-1" style="opacity: 0.8;">
                  ${timestamp}
              </small>
          </div>
      `;

      // Add to the chat container
      messagesContainer.appendChild(messageDiv);
  }

  // Function to scroll to the bottom of the chat
  function scrollToBottom() {
      const messagesContainer = document.getElementById('chat-messages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Scroll to bottom when page loads
  scrollToBottom();
</script>
{% endif %} {% endblock %}
