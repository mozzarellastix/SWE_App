{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Messages ‚Äî Vaquero Social</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{% static 'css/common.css' %}" />
  <link rel="stylesheet" href="{% static 'css/messages.css' %}" />
</head>
<body>

<div class="container">

  <!-- Header -->
  <header class="appbar">
    <div class="top-left">
      <div class="back-btn" onclick="history.back()">‚Üê</div>
      <div class="brand">
        <img src="https://images.vexels.com/media/users/3/252889/isolated/preview/02e0a9c8d1b16f3f23d96715d114168e-cowboy-with-lasso-and-horse-silhouette.png" 
             alt="Logo (Cowboy holding a lasso)" style="width:32px; height:32px; border-radius:50%; object-fit:cover; margin-right:8px;" />
        Lasso
      </div>
    </div>

    <div class="search">
      <input id="searchInput" placeholder="Search campus..." />
    </div>

    <div class="top-actions">
      <div id="notifyBell" style="background:white;padding:8px;border-radius:8px;cursor:pointer;">üîî</div>
      <div class="avatar"></div>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <nav class="nav">
      <a href="{% url 'feed' %}">üè† Home</a>
      <a href="{% url 'messages' %}" class="active">üí¨ Messages</a>
      <a href="{% url 'events' %}">üìÖ Events</a>
      <a href="{% url 'profile' %}">üë§ Profile</a>
    </nav>
    <form method="post" action="{% url 'logout' %}" style="margin:0;">
      {% csrf_token %}
      <button type="submit" class="logout">‚ü≤ Log out</button>
    </form>
  </aside>

  <!-- Main Content -->
  <main class="messages-main">
    <div class="messages-container">

      <!-- LEFT SIDEBAR: List of users -->
      <aside class="users-sidebar">
        <div class="sidebar-header">Conversations</div>
        <div class="users-list">
          {% for user in users %}
          <a href="?user_id={{ user.id }}" 
             class="user-item {% if conversation_with and conversation_with.id == user.id %}active{% endif %}">
            <div class="user-avatar">{{ user.username|slice:":1"|upper }}</div>
            <div class="user-info">
              <strong>{{ user.username }}</strong>
              <small>{{ user.email }}</small>
            </div>
          </a>
          {% empty %}
          <div class="empty-state">No users available</div>
          {% endfor %}
        </div>
      </aside>

      <!-- RIGHT: Chat area -->
      <div class="chat-area">
        {% if conversation_with %}
        <div class="chat-card">
          <div class="chat-header">
            üí¨ Chat with {{ conversation_with.username }}
          </div>

          <div id="chat-messages" class="chat-messages">
            {% for message in conversation_messages %}
            <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
              <div class="message-bubble">
                <strong>{{ message.sender.username }}</strong>
                <div class="message-content">{{ message.content }}</div>
                <small class="message-time">{{ message.timestamp|date:"M d, h:i A" }}</small>
              </div>
            </div>
            {% empty %}
            <div class="empty-chat">
              <p>No messages yet. Start the conversation!</p>
            </div>
            {% endfor %}
          </div>

          <div class="chat-footer">
            <form id="chat-form">
              {% csrf_token %}
              <input type="hidden" id="receiver-id" value="{{ conversation_with.id }}" />
              <input type="text" id="message-input" placeholder="Type your message..." required autofocus />
              <button type="submit">Send</button>
            </form>
          </div>
        </div>
        {% else %}
        <div class="chat-card empty">
          <div class="empty-chat-placeholder">
            <h4>üëà Select a user to start chatting</h4>
            <p>Choose someone from the list on the left</p>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </main>

  <!-- Right sidebar (events or suggestions, optional) -->
  <aside class="right-col">
    <!-- Empty for now, can add suggestions later -->
  </aside>

</div>

{% if conversation_with %}
<script>
  /*
   * REAL-TIME CHAT WITH WEBSOCKETS
   *
   * How it works:
   * 1. Create a WebSocket connection to the server
   * 2. Listen for incoming messages from the server
   * 3. When user sends a message, send it via WebSocket (not HTTP form)
   * 4. Display incoming messages in real-time without page refresh
   */

  // Get the current user ID and conversation partner ID
  const currentUserId = {{ request.user.id }};
  const otherUserId = {{ conversation_with.id }};

  // Determine WebSocket protocol (ws:// for http, wss:// for https)
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

  // Create WebSocket connection
  // This connects to our ChatConsumer at ws://localhost:8000/ws/chat/5/
  const chatSocket = new WebSocket(
      protocol + '//' + window.location.host + '/ws/chat/' + otherUserId + '/'
  );

  // Event: WebSocket connection opened
  chatSocket.onopen = function(e) {
      console.log('WebSocket connected!');
  };

  // Event: Received a message from the server
  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log('Received message:', data);

      // Add the new message to the chat display
      appendMessage(
          data.sender_username,
          data.message,
          data.timestamp,
          data.sender_id === currentUserId
      );

      // Scroll to the bottom to show the new message
      scrollToBottom();
  };

  // Event: WebSocket connection closed
  chatSocket.onclose = function(e) {
      console.log('WebSocket disconnected');
  };

  // Event: WebSocket error
  chatSocket.onerror = function(e) {
      console.error('WebSocket error:', e);
  };

  // Handle form submission
  document.getElementById('chat-form').onsubmit = function(e) {
      e.preventDefault();  // Prevent normal form submission

      const messageInput = document.getElementById('message-input');
      const message = messageInput.value.trim();

      if (message) {
          // Send message via WebSocket (not HTTP POST)
          chatSocket.send(JSON.stringify({
              'message': message,
              'receiver_id': otherUserId
          }));

          // Clear the input field
          messageInput.value = '';
      }
  };

  // Function to add a new message to the display
  function appendMessage(senderUsername, content, timestamp, isCurrentUser) {
      const messagesContainer = document.getElementById('chat-messages');

      // Create message HTML
      const messageDiv = document.createElement('div');
      messageDiv.className = 'mb-3 ' + (isCurrentUser ? 'text-end' : '');

      messageDiv.innerHTML = `
          <div class="d-inline-block p-3 rounded shadow-sm ${isCurrentUser ? 'bg-primary text-white' : 'bg-white'}"
               style="max-width: 70%;">
              <small class="d-block">
                  <strong>${senderUsername}</strong>
              </small>
              <div>${content}</div>
              <small class="d-block mt-1" style="opacity: 0.8;">
                  ${timestamp}
              </small>
          </div>
      `;

      // Add to the chat container
      messagesContainer.appendChild(messageDiv);
  }

  // Function to scroll to the bottom of the chat
  function scrollToBottom() {
      const messagesContainer = document.getElementById('chat-messages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Scroll to bottom when page loads
  scrollToBottom();
</script>
{% endif %}
</body>
</html>